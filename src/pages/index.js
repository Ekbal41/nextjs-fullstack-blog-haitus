import Head from 'next/head'
import { useEffect, useState } from 'react'
import Link from 'next/link'
import { useRouter } from 'next/router'
import moment from 'moment/moment'



export default function Home({ posts }) {
  const [user, setUser] = useState('')
  const router = useRouter()

  const [allPosts, setallPosts] = useState([])

  useEffect(() => {
    setallPosts(posts.reverse())

    if (typeof window !== "undefined") {
      const user = localStorage.getItem("user");
      if (user) {
        setUser(user);
      }
    }

  }, [router.asPath])



  return (
    <>
      <Head>
        <title> Next Blog</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>


        <div className="container top-110 flex-column flex-md-row  d-flex mx-auto "

        >


          <div className=" "
            style={{
              marginRight: '3rem',
              minWidth: '50rem',
              minHeight: '100vh',
            }}
          >
            <div className="card border-light mb-3" style={{
              maxWidth: '50rem',
            }}>
              <div className='d-flex justify-content-between mb-4'>
                <ol className="breadcrumb">

                  <li className="breadcrumb-item active">

                    Home | üñäÔ∏è <span className="text-capitalize">{user ? user : "Unregistered"}</span>
                  </li>

                </ol>
                <button className="btn btn-primary rounded "

                >
                  {
                    user ? (
                      <Link className="nav-link" href="addpost">
                        Create New Post
                      </Link>
                    ) : (
                      <Link className="nav-link" href="login">
                        Login to Create Post
                      </Link>
                    )
                  }
                </button>
              </div>

              {
                posts.length > 0 ? (allPosts.map((post, index) => (
                  <div key={index}>

                    <div className="card-header text-primary fw-bold">
                      {post.title}

                      <i className="bi bi-box-arrow-up-right mx-2"></i>
                      <div className="float-end">

                        <span className="mx-2">
                          {moment(post.date).fromNow()}
                        </span>
                        <span class="text-capitalize "> By {post.author.name} |</span>

                        <i className=" icon bi bi-facebook"></i>
                        <i className=" icon bi bi-share-fill"></i>
                        <i className=" icon bi bi-bookmark-plus-fill"></i>
                        {/* <i class="bi bi-bookmark-check-fill"></i> */}
                      </div>
                    </div>
                    <div className="card-body">
                      <p className="card-text">
                        {post.content}
                      </p>

                    </div>
                  </div>
                )))
                  : (
                    <div className=" text-center mt-5 text-primary fw-bold">No Posts Found</div>
                  )

              }



            </div>


          </div>
          <div>
            <div className="card border-primary mb-3 rounded" style={{
              maxWidth: '20rem',
            

            }}>
              <div className="card-header  text-primary"><i className=" icon bi bi-person-circle"></i><span className="text-capitalize">{user ? user : "Unregistered"}</span> <Link href="logout"> <i className=" fw-bold float-end bi bi-door-open"></i> </Link> </div>
              <div className="card-body border border-primary">

                <img
                  src="/man.png" height={70} width={70}
                  style={{
                    objectFit: 'cover',
                    borderRadius: "50%",
                    border: "2px solid #593196",
                  }}
                  className=" mx-auto d-block" alt="..."></img>
                <h5 className="card-title text-center mt-2 text-capitalize">{user}</h5>
                <div className=" "
                  style={{
                    marginLeft: '70px',
                    marginBottom: '10px',
                  }}
                >
                  <i className=" icon bi bi-facebook text-primary"></i>
                  <i className=" icon bi bi-twitter text-primary"></i>
                  <i className=" icon bi bi-instagram text-primary"></i>
                </div>
                <p className="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </>
  )
}

export const getServerSideProps = async (context) => {
  //get the user from the server
  const token = context.req.cookies.token || "";

  console.log('token hocche', token)

  var posts;

  if (token) {

    const res = await fetch('http://localhost:3000/api/posts?id=' + process.env.NEXT_PUBLIC_KEY, {
      method: 'GET',
      headers: {
        cookie: "token=" + token,
      }
    })
    const data = await res.json()
    posts = data.posts

  }
  if (!token) {
    posts = []
  }


  return {
    props: {
      posts: posts

    }
  }

}